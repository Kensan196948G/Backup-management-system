# 認証・認可設計書

**プロジェクト名:** バックアップ管理システム WebUI
**バージョン:** 1.0.0
**作成日:** 2026-02-25

---

## 1. 認証方式

### 1.1 JWT ベース認証

本システムでは **JWT（JSON Web Token）** を使用したステートレス認証を採用します。

**トークン構成:**

| トークン種別 | 保存場所 | 有効期限 | 説明 |
|-----------|---------|---------|------|
| Access Token | メモリ（JS変数） | 15 分 | API 認証用 |
| Refresh Token | HttpOnly Cookie | 7 日 | Access Token 更新用 |

**Access Token ペイロード:**
```json
{
  "sub": "user-uuid",
  "email": "admin@example.com",
  "role": "admin",
  "iat": 1740470400,
  "exp": 1740471300,
  "jti": "token-uuid"
}
```

### 1.2 トークン保存方針

- Access Token をローカルストレージに保存しない（XSS 攻撃対策）
- Refresh Token は HttpOnly + Secure + SameSite=Strict Cookie に保存
- ページリロード時は Refresh Token で Access Token を再取得

---

## 2. 認証フロー

### 2.1 ログインフロー

```
ユーザー
  │ メールアドレス + パスワード入力
  ▼
フロントエンド
  │ POST /api/v1/auth/login
  ▼
バックエンド
  │ 1. メールアドレスでユーザー検索
  │ 2. bcrypt でパスワード検証
  │ 3. アカウントロック確認
  │ 4. Access Token + Refresh Token 生成
  │    └── Refresh Token を DB（user_sessions）に保存（ハッシュ値）
  │ 5. レスポンス返却
  ▼
フロントエンド
  │ Access Token をメモリに保存
  │ Refresh Token は HttpOnly Cookie として受信（バックエンドが Set-Cookie）
  ▼
ダッシュボードへリダイレクト
```

### 2.2 API リクエストフロー

```
フロントエンド
  │ API リクエスト（Authorization: Bearer {access_token}）
  ▼
バックエンド JWT ミドルウェア
  │ 1. Authorization ヘッダー検証
  │ 2. JWT 署名検証
  │ 3. 有効期限確認
  │    ├── 有効: next() でハンドラへ
  │    └── 期限切れ: 401 返却
  ▼
ハンドラ処理
```

### 2.3 トークン更新フロー（Silent Refresh）

```
フロントエンド（axios インターセプター）
  │ 401 Unauthorized 受信
  ▼
  │ POST /api/v1/auth/refresh（HttpOnly Cookie 自動送信）
  ▼
バックエンド
  │ 1. Cookie から Refresh Token 取得
  │ 2. DB でトークン検証
  │ 3. 新しい Access Token 発行
  ▼
フロントエンド
  │ 新 Access Token をメモリに保存
  │ 失敗したリクエストをリトライ
```

### 2.4 ログアウトフロー

```
フロントエンド
  │ ログアウトボタンクリック
  ▼
  │ POST /api/v1/auth/logout
  ▼
バックエンド
  │ 1. Refresh Token を DB で無効化（revoked_at 設定）
  │ 2. Cookie を削除（Max-Age=0）
  ▼
フロントエンド
  │ メモリの Access Token を削除
  │ /login へリダイレクト
```

---

## 3. パスワードポリシー

| ルール | 設定 |
|--------|------|
| 最小文字数 | 12 文字 |
| 最大文字数 | 128 文字 |
| 大文字 | 1 文字以上必須 |
| 小文字 | 1 文字以上必須 |
| 数字 | 1 文字以上必須 |
| 特殊文字 | 1 文字以上必須（`!@#$%^&*`） |
| 過去パスワード | 直近 5 回は使用禁止 |
| 有効期限 | 90 日（警告は 14 日前から） |

### アカウントロックポリシー

| 設定 | 値 |
|------|-----|
| 連続失敗回数 | 5 回 |
| ロック時間 | 30 分（自動解除） |
| 管理者による強制解除 | 可能 |

---

## 4. 認可（RBAC）

### 4.1 ロール定義

| ロール | コード | 説明 |
|--------|--------|------|
| システム管理者 | `admin` | 全権限 |
| バックアップオペレーター | `operator` | ジョブ管理・実行権限 |
| 閲覧者 | `viewer` | 読み取りのみ |

### 4.2 権限マトリクス

| リソース | 操作 | admin | operator | viewer |
|---------|------|-------|---------|--------|
| ダッシュボード | 閲覧 | ○ | ○ | ○ |
| バックアップジョブ | 閲覧 | ○ | ○ | ○ |
| バックアップジョブ | 作成・編集 | ○ | ○ | × |
| バックアップジョブ | 削除 | ○ | × | × |
| バックアップジョブ | 即時実行 | ○ | ○ | × |
| レポート | 閲覧・生成 | ○ | ○ | ○ |
| レポート | スケジュール設定 | ○ | ○ | × |
| アラートルール | 閲覧 | ○ | ○ | ○ |
| アラートルール | 作成・編集・削除 | ○ | ○ | × |
| ユーザー管理 | 閲覧 | ○ | × | × |
| ユーザー管理 | 作成・編集・削除 | ○ | × | × |
| システム設定 | 閲覧・編集 | ○ | × | × |
| ストレージプール | 管理 | ○ | × | × |
| 監査ログ | 閲覧 | ○ | × | × |

---

## 5. セッション管理

### 5.1 セッションタイムアウト

| 種別 | 時間 | 動作 |
|------|------|------|
| アクセストークン | 15 分 | 自動更新（Refresh Token 有効時） |
| アイドルタイムアウト | 60 分 | 操作なしで自動ログアウト |
| 絶対タイムアウト | 24 時間 | 再ログイン必須 |
| Remember me | 7 日 | Refresh Token 有効期限を延長 |

### 5.2 同時セッション制御

- デフォルト: 同一ユーザーの同時セッション数に制限なし（管理者設定で変更可）
- 最大セッション数を超えた場合: 最も古いセッションを無効化

---

## 6. 多要素認証（MFA）

### 対応方式

| 方式 | 説明 | 状態 |
|------|------|------|
| TOTP（Google Authenticator 等） | 6 桁の時刻ベースワンタイムパスワード | 実装予定 |
| メール OTP | 6 桁のメール送信コード | 実装予定 |

---

## 更新履歴

| 日付 | バージョン | 更新者 | 内容 |
|------|-----------|--------|------|
| 2026-02-25 | 1.0.0 | システム管理者 | 初版作成 |
