# 運用・保守マニュアル

**プロジェクト名:** バックアップ管理システム WebUI
**バージョン:** 1.0.0
**作成日:** 2026-02-25

---

## 1. 日常監視

### 1.1 監視チェックリスト（毎日）

| 項目 | 確認方法 | 正常基準 |
|------|---------|---------|
| システム稼働確認 | `GET /health/ready` | 200 OK |
| バックアップジョブ成功率 | ダッシュボード確認 | 95% 以上 |
| 失敗ジョブの確認 | ダッシュボード → 失敗カード | 0 件が理想 |
| ストレージ使用率 | ダッシュボード → ストレージウィジェット | 80% 未満 |
| エラーログ確認 | ログ監視ツール（Grafana等） | ERROR ログ 0 件が理想 |

### 1.2 監視チェックリスト（週次）

| 項目 | 確認方法 |
|------|---------|
| パフォーマンスメトリクス確認 | Grafana ダッシュボード |
| DB サイズ・インデックス最適化 | `pg_stat_user_tables` 確認 |
| セキュリティアラート確認 | セキュリティ監視ツール |
| 証明書有効期限確認 | `openssl s_client` または監視アラート |

---

## 2. 定期メンテナンス

### 2.1 月次メンテナンス

| 作業 | 内容 | 所要時間 |
|------|------|---------|
| DB バキューム / 統計更新 | `VACUUM ANALYZE` 実行 | 30 分 |
| ログローテーション確認 | 古いログの削除・アーカイブ | 15 分 |
| セキュリティパッチ適用 | OS / Docker イメージ更新 | 1〜2 時間 |
| バックアップ復元テスト | テスト環境で復元確認 | 2 時間 |

### 2.2 四半期メンテナンス

- セキュリティ診断の実施
- 依存ライブラリのメジャーバージョンアップ検討
- パフォーマンスベンチマークの実施
- DR（災害復旧）訓練

---

## 3. 障害対応手順

### 3.1 障害レベル定義

| レベル | 定義 | 対応時間 |
|--------|------|---------|
| P1（重大） | サービス完全停止・全ユーザーへの影響 | 30 分以内 |
| P2（高） | 主要機能の停止・多くのユーザーへの影響 | 2 時間以内 |
| P3（中） | 一部機能の劣化・限定的な影響 | 次営業日 |
| P4（低） | 軽微な問題・回避策あり | 計画的対応 |

### 3.2 P1 障害対応フロー

```
1. 検知（監視アラートまたはユーザー報告）
   ↓
2. 初動対応（5分以内）
   - 状況の確認（ヘルスチェックエンドポイント）
   - 関係者への連絡（インシデント管理ツール）
   ↓
3. 影響範囲の特定（15分以内）
   - アクセスログの確認
   - エラーログの確認
   - DB / Redis の状態確認
   ↓
4. 暫定対応（30分以内）
   - サービス再起動（必要な場合）
   - トラフィック切り替え（フェイルオーバー）
   ↓
5. 根本原因の調査
   ↓
6. 恒久対応
   ↓
7. ポストモーテム（48時間以内に作成）
```

### 3.3 よくある障害と対処法

**障害: API 応答が遅い**
```bash
# 1. DB コネクション状態確認
docker compose exec db psql -U postgres -c "SELECT count(*) FROM pg_stat_activity;"

# 2. スロークエリ確認
docker compose exec db psql -U postgres -c "
SELECT query, calls, total_exec_time/calls AS avg_ms
FROM pg_stat_statements
ORDER BY avg_ms DESC LIMIT 10;"

# 3. Redis 接続確認
docker compose exec redis redis-cli -a $REDIS_PASSWORD ping
```

**障害: コンテナが起動しない**
```bash
# ログ確認
docker compose logs --tail=100 backend

# 再起動
docker compose restart backend

# 完全再起動（設定ファイル変更後）
docker compose down && docker compose up -d
```

**障害: DB 接続エラー**
```bash
# DB 状態確認
docker compose ps db

# DB 起動
docker compose start db

# コネクション数確認
docker compose exec db psql -U postgres -c "SELECT count(*) FROM pg_stat_activity WHERE state = 'active';"
```

---

## 4. バックアップ・リストア

### 4.1 DB バックアップ

```bash
# 手動バックアップ
docker compose exec db pg_dump -U postgres backup_mgmt \
  | gzip > /backup/db/$(date +%Y%m%d_%H%M%S).sql.gz

# 自動バックアップ（cron）
0 3 * * * /opt/scripts/backup-db.sh

# 保持期間: 30 日間
```

### 4.2 リストア手順

```bash
# 1. サービスを停止
docker compose stop backend celery celery-beat

# 2. DB をリストア
gunzip -c /backup/db/20260225_030000.sql.gz \
  | docker compose exec -T db psql -U postgres backup_mgmt

# 3. サービスを再起動
docker compose start backend celery celery-beat

# 4. 動作確認
curl -f https://backup-mgmt.example.com/health/ready
```

---

## 5. ログ管理

### 5.1 ログファイルの場所

| ログ種別 | 場所 | 保持期間 |
|---------|------|---------|
| アプリケーションログ | `docker logs backup-backend` | 30 日 |
| Nginx アクセスログ | `/var/log/nginx/access.log` | 90 日 |
| Nginx エラーログ | `/var/log/nginx/error.log` | 90 日 |
| 監査ログ | DB: `audit_logs` テーブル | 365 日 |

### 5.2 ログレベル変更（一時的）

```bash
# DEBUG レベルに変更（本番では短時間のみ）
docker compose exec backend sh -c "LOG_LEVEL=debug kill -USR1 1"

# INFO レベルに戻す
docker compose exec backend sh -c "LOG_LEVEL=info kill -USR1 1"
```

---

## 6. SSL 証明書管理

### 6.1 証明書更新（Let's Encrypt）

```bash
# 証明書の有効期限確認
openssl x509 -enddate -noout -in /etc/nginx/ssl/cert.pem

# 手動更新
certbot renew --nginx

# 自動更新確認（cron）
0 0 1 * * certbot renew --quiet && nginx -s reload
```

### 6.2 証明書有効期限アラート

- 30 日前: 警告メール送信
- 7 日前: 緊急メール送信・担当者へ電話
- 監視ツールで毎日チェック

---

## 更新履歴

| 日付 | バージョン | 更新者 | 内容 |
|------|-----------|--------|------|
| 2026-02-25 | 1.0.0 | システム管理者 | 初版作成 |
