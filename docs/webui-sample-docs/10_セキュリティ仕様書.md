# セキュリティ仕様書

**プロジェクト名:** バックアップ管理システム WebUI
**バージョン:** 1.0.0
**作成日:** 2026-02-25
**準拠標準:** OWASP Top 10 2021 / ISO/IEC 27001

---

## 1. セキュリティ要件概要

本システムはバックアップという業務上重要なデータを扱うため、機密性・完全性・可用性の確保を最優先とします。

---

## 2. OWASP Top 10 対策

### A01: アクセス制御の不備

- RBAC による最小権限の原則の実装（09_認証・認可設計書参照）
- すべての API エンドポイントで認証・認可を強制
- UUID の使用による連番推測攻撃の防止
- 他ユーザーのデータへの横断アクセスをサーバー側で検証

### A02: 暗号化の失敗

- 通信: HTTPS (TLS 1.2+) の強制リダイレクト
- パスワード: bcrypt（コスト係数 12）によるハッシュ化
- 機密設定値（接続文字列等）: AES-256-GCM で暗号化して DB に保存
- 秘密鍵・証明書: 環境変数または HSM で管理（コードに含めない）

### A03: インジェクション

**SQLインジェクション対策:**
- SQLAlchemy ORM のパラメータ化クエリを使用
- 生 SQL が必要な場合は `text()` + バインドパラメータを必須とする
- ユーザー入力の直接SQL連結を禁止

**XSS 対策:**
- React の JSX による自動エスケープ
- `dangerouslySetInnerHTML` の使用禁止（例外は承認プロセスを経る）
- Content-Security-Policy ヘッダーの設定

**CSP 設定:**
```
Content-Security-Policy:
  default-src 'self';
  script-src 'self';
  style-src 'self' 'unsafe-inline';
  img-src 'self' data:;
  connect-src 'self' wss:;
  frame-ancestors 'none';
```

### A04: 安全でない設計

- セキュリティ設計の脅威モデリングを実施（STRIDE）
- 設計レビューにセキュリティチェックリストを含める
- 最小権限・多層防御の設計原則

### A05: セキュリティの設定ミス

- 本番環境でのデバッグモード無効化
- デフォルト認証情報の変更を初期セットアップで強制
- 不要なエンドポイント・ポートの無効化
- セキュリティヘッダーの設定

### A06: 脆弱性のあるコンポーネント

- `npm audit` / `safety` による依存関係の定期チェック（CI で自動化）
- Dependabot による自動アップデート PR
- SBOM（ソフトウェア部品表）の管理

### A07: 認証・セッション管理の不備

- JWT の適切な実装（09_認証・認可設計書参照）
- パスワードポリシーの強制
- アカウントロック機能

### A08: ソフトウェアとデータの整合性の不備

- CI/CD パイプラインでコード署名を検証
- Docker イメージの脆弱性スキャン（Trivy）
- 依存関係のハッシュ検証（lock ファイルの使用）

### A09: セキュリティログとモニタリングの不備

- 全認証イベントのログ記録
- 重要操作の監査ログ（1 年間保持）
- 異常アクセスのアラート設定
- ログの改ざん防止（追記専用）

### A10: サーバーサイドリクエストフォージェリ

- 外部 URL へのリクエストには許可リストを設ける
- 内部 IP・メタデータエンドポイントへのアクセスをブロック

---

## 3. セキュリティヘッダー

| ヘッダー | 設定値 | 目的 |
|---------|--------|------|
| `Strict-Transport-Security` | `max-age=63072000; includeSubDomains` | HTTPS 強制 |
| `X-Content-Type-Options` | `nosniff` | MIME スニッフィング防止 |
| `X-Frame-Options` | `DENY` | クリックジャッキング防止 |
| `X-XSS-Protection` | `1; mode=block` | 旧ブラウザ XSS 防止 |
| `Referrer-Policy` | `strict-origin-when-cross-origin` | 参照元制御 |
| `Permissions-Policy` | `camera=(), microphone=(), geolocation=()` | 機能制限 |

---

## 4. CSRF 対策

- SameSite=Strict Cookie による CSRF 防止
- 状態変更 API（POST/PUT/PATCH/DELETE）に CSRF トークンを要求
- Origin ヘッダーの検証

---

## 5. 通信セキュリティ

### TLS 設定

| 設定 | 値 |
|------|-----|
| 最低 TLS バージョン | 1.2 |
| 推奨 TLS バージョン | 1.3 |
| 許可 Cipher Suite | ECDHE-RSA-AES256-GCM-SHA384 等（強度 256bit 以上） |
| 禁止 | SSL 2.0 / 3.0 / TLS 1.0 / 1.1 / RC4 / DES / 3DES |
| HSTS | 有効（2 年間） |

### WebSocket セキュリティ

- `wss://` (TLS 付き) のみ許可
- 接続時に JWT Access Token を検証
- 接続ごとにタイムアウト（30 分）

---

## 6. 入力バリデーション

| 対象 | バリデーション |
|------|-------------|
| テキスト入力 | 最大文字数・許可文字種の制限 |
| ファイルパス | パストラバーサル防止（`../` 等の禁止） |
| URL | 許可スキーム（http/https）・ホワイトリスト |
| 数値 | 型・範囲チェック |
| JSON | スキーマバリデーション（Zod / Pydantic） |

---

## 7. 脆弱性診断計画

| 種別 | 頻度 | 実施者 |
|------|------|--------|
| 自動スキャン（SAST） | CI/CD 毎回 | 自動 |
| 依存関係チェック | 週次 | 自動 |
| 動的スキャン（DAST） | 四半期 | セキュリティチーム |
| ペネトレーションテスト | 年次 | 外部ベンダー |

---

## 8. インシデント対応

1. **検知** → SIEM アラート / 監査ログ異常
2. **初動** → 影響ユーザーのセッション強制失効
3. **封じ込め** → 該当 IP ブロック / アカウント無効化
4. **調査** → 監査ログ・アクセスログ分析
5. **通知** → 個人情報漏洩の場合は 72 時間以内に規制当局へ報告
6. **復旧** → 脆弱性修正・パッチ適用
7. **再発防止** → ポストモーテム・セキュリティ強化

---

## 更新履歴

| 日付 | バージョン | 更新者 | 内容 |
|------|-----------|--------|------|
| 2026-02-25 | 1.0.0 | システム管理者 | 初版作成 |
