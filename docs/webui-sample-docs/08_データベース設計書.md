# データベース設計書

**プロジェクト名:** バックアップ管理システム WebUI
**バージョン:** 1.0.0
**作成日:** 2026-02-25
**DBMS:** PostgreSQL 15

---

## 1. 設計方針

- UUID を主キーとして使用（分散環境・セキュリティ考慮）
- 論理削除（soft delete）を採用（`deleted_at` カラム）
- 全テーブルに `created_at` / `updated_at` を付与
- タイムゾーンは UTC で統一（アプリ側で変換）
- インデックスは必要最小限に留め、過剰インデックスを避ける

---

## 2. ER 図（テキスト表現）

```
users
  |──< user_sessions (1:N)
  |
  └──< job_executions (監査用)

backup_jobs
  |──< job_executions (1:N)
  |──< job_schedules (1:1)
  |──< job_notifications (1:N)
  |──< compliance_evidences (1:N)
  |──< compliance_snapshots (1:N)
  |
  └──> storage_pools (N:1)

alert_rules
  └──< alert_history (1:N)

reports
  └──< report_schedules (1:1)
```

---

## 3. テーブル定義

### 3.1 users（ユーザー）

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | 主キー |
| email | VARCHAR(255) | NOT NULL | - | メールアドレス（一意） |
| display_name | VARCHAR(100) | NOT NULL | - | 表示名 |
| password_hash | VARCHAR(60) | NOT NULL | - | bcrypt ハッシュ |
| role | VARCHAR(20) | NOT NULL | 'viewer' | admin / operator / viewer |
| is_active | BOOLEAN | NOT NULL | true | アカウント有効フラグ |
| failed_login_count | INTEGER | NOT NULL | 0 | 連続失敗回数 |
| locked_until | TIMESTAMPTZ | - | - | ロック解除日時 |
| last_login_at | TIMESTAMPTZ | - | - | 最終ログイン日時 |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | NOT NULL | NOW() | 更新日時 |
| deleted_at | TIMESTAMPTZ | - | - | 論理削除日時 |

**インデックス:**
- `UNIQUE (email)` ※ `deleted_at IS NULL` 条件付き

---

### 3.2 user_sessions（ユーザーセッション）

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NOT NULL | 主キー |
| user_id | UUID | NOT NULL | FK: users.id |
| refresh_token_hash | VARCHAR(64) | NOT NULL | SHA-256 ハッシュ |
| user_agent | TEXT | - | UA 文字列 |
| ip_address | INET | - | クライアント IP |
| expires_at | TIMESTAMPTZ | NOT NULL | 有効期限 |
| revoked_at | TIMESTAMPTZ | - | 無効化日時 |
| created_at | TIMESTAMPTZ | NOT NULL | 作成日時 |

**インデックス:**
- `INDEX (user_id)`
- `INDEX (refresh_token_hash)`

---

### 3.3 backup_jobs（バックアップジョブ）

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|----------|------|
| id | UUID | NOT NULL | gen_random_uuid() | 主キー |
| name | VARCHAR(100) | NOT NULL | - | ジョブ名 |
| description | TEXT | - | - | 説明 |
| type | VARCHAR(20) | NOT NULL | - | full / differential / incremental |
| enabled | BOOLEAN | NOT NULL | true | 有効フラグ |
| source_config | JSONB | NOT NULL | - | ソース設定 |
| destination_config | JSONB | NOT NULL | - | 保存先設定 |
| storage_pool_id | UUID | - | - | FK: storage_pools.id |
| last_execution_id | UUID | - | - | FK: job_executions.id |
| last_run_at | TIMESTAMPTZ | - | - | 最終実行日時 |
| last_run_status | VARCHAR(20) | - | - | 最終実行ステータス |
| last_run_size_bytes | BIGINT | - | - | 最終実行サイズ |
| compliance_32110_policy | JSONB | - | - | 3-2-1-1-0 判定ポリシー（required copies/media/offsite/immutable/verify） |
| compliance_32110_last_status | VARCHAR(20) | - | - | compliant / warning / non_compliant |
| compliance_32110_last_evaluated_at | TIMESTAMPTZ | - | - | 最終評価日時 |
| created_by | UUID | NOT NULL | - | FK: users.id |
| created_at | TIMESTAMPTZ | NOT NULL | NOW() | 作成日時 |
| updated_at | TIMESTAMPTZ | NOT NULL | NOW() | 更新日時 |
| deleted_at | TIMESTAMPTZ | - | - | 論理削除日時 |

**インデックス:**
- `INDEX (enabled, deleted_at)` — 有効ジョブ取得用
- `INDEX (last_run_at DESC)` — 最近実行順ソート用

---

### 3.4 job_schedules（ジョブスケジュール）

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NOT NULL | 主キー |
| job_id | UUID | NOT NULL | FK: backup_jobs.id（一意） |
| schedule_type | VARCHAR(20) | NOT NULL | cron / interval / once |
| cron_expression | VARCHAR(100) | - | cron 式 |
| interval_seconds | INTEGER | - | 間隔（秒） |
| run_at | TIMESTAMPTZ | - | 1 回実行日時 |
| timezone | VARCHAR(50) | NOT NULL | タイムゾーン |
| next_run_at | TIMESTAMPTZ | - | 次回実行予定 |
| is_active | BOOLEAN | NOT NULL | スケジュール有効フラグ |

---

### 3.5 job_executions（ジョブ実行履歴）

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NOT NULL | 主キー |
| job_id | UUID | NOT NULL | FK: backup_jobs.id |
| status | VARCHAR(20) | NOT NULL | running / success / error / cancelled |
| trigger_type | VARCHAR(20) | NOT NULL | scheduled / manual / api |
| triggered_by | UUID | - | FK: users.id（手動実行時） |
| started_at | TIMESTAMPTZ | NOT NULL | 開始日時 |
| completed_at | TIMESTAMPTZ | - | 完了日時 |
| duration_seconds | INTEGER | - | 所要時間（秒） |
| size_bytes | BIGINT | - | バックアップサイズ |
| files_count | INTEGER | - | ファイル数 |
| error_message | TEXT | - | エラーメッセージ |
| log_path | TEXT | - | ログファイルパス |
| metadata | JSONB | - | 追加メタデータ |
| verification_status | VARCHAR(20) | - | 復元検証結果（success / error / pending / skipped） |
| verification_completed_at | TIMESTAMPTZ | - | 検証完了日時 |
| offsite_sync_status | VARCHAR(20) | - | オフサイト同期状態（success / error / pending） |
| offsite_synced_at | TIMESTAMPTZ | - | オフサイト同期完了日時 |
| immutable_snapshot | BOOLEAN | - | 実行時点の不変性有効フラグ |

**インデックス:**
- `INDEX (job_id, started_at DESC)` — ジョブ別履歴取得用
- `INDEX (status, started_at DESC)` — ステータスフィルタ用

---

### 3.6 storage_pools（ストレージプール）

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NOT NULL | 主キー |
| name | VARCHAR(100) | NOT NULL | プール名 |
| type | VARCHAR(30) | NOT NULL | local / nfs / s3 / azure_blob |
| connection_config | JSONB | NOT NULL | 接続設定（暗号化保存） |
| total_bytes | BIGINT | - | 総容量 |
| used_bytes | BIGINT | - | 使用量 |
| is_active | BOOLEAN | NOT NULL | 有効フラグ |
| last_checked_at | TIMESTAMPTZ | - | 最終疎通確認日時 |
| created_at | TIMESTAMPTZ | NOT NULL | 作成日時 |
| updated_at | TIMESTAMPTZ | NOT NULL | 更新日時 |

---

### 3.7 compliance_evidences（3-2-1-1-0 準拠証跡）

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NOT NULL | 主キー |
| job_id | UUID | NOT NULL | FK: backup_jobs.id |
| execution_id | UUID | - | FK: job_executions.id |
| evidence_type | VARCHAR(30) | NOT NULL | copies / media / offsite / immutable / verification |
| status | VARCHAR(20) | NOT NULL | success / warning / error / pending |
| captured_at | TIMESTAMPTZ | NOT NULL | 証跡取得日時 |
| payload | JSONB | NOT NULL | 証跡詳細（コピー数、媒体種別、検証結果等） |
| request_id | UUID | - | 追跡用リクエスト ID |
| created_at | TIMESTAMPTZ | NOT NULL | 作成日時 |

**インデックス:**
- `INDEX (job_id, captured_at DESC)`
- `INDEX (evidence_type, status, captured_at DESC)`

---

### 3.8 compliance_snapshots（準拠判定スナップショット）

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | UUID | NOT NULL | 主キー |
| scope_type | VARCHAR(20) | NOT NULL | job / system |
| scope_id | UUID | - | job 単位時の対象 ID |
| overall_status | VARCHAR(20) | NOT NULL | compliant / warning / non_compliant |
| checks | JSONB | NOT NULL | 3/2/1/1/0 各判定の集計値 |
| evaluated_at | TIMESTAMPTZ | NOT NULL | 評価日時 |
| report_id | UUID | - | FK: reports.id（レポート生成時） |
| created_at | TIMESTAMPTZ | NOT NULL | 作成日時 |

**用途:**
- ダッシュボード表示高速化
- レポート生成時の判定結果固定化（証跡保持）

---

### 3.9 audit_logs（監査ログ）

| カラム名 | 型 | NULL | 説明 |
|---------|-----|------|------|
| id | BIGSERIAL | NOT NULL | 主キー |
| user_id | UUID | - | 操作者（システムの場合NULL） |
| action | VARCHAR(50) | NOT NULL | 操作種別 |
| resource_type | VARCHAR(50) | NOT NULL | リソース種別 |
| resource_id | UUID | - | リソース ID |
| old_value | JSONB | - | 変更前の値 |
| new_value | JSONB | - | 変更後の値 |
| ip_address | INET | - | クライアント IP |
| request_id | UUID | - | リクエスト ID |
| created_at | TIMESTAMPTZ | NOT NULL | 記録日時 |

**パーティション:** `created_at` による月次パーティション（12 ヶ月保持）

---

## 4. マイグレーション管理

- ツール: Alembic
- 命名規則: `{revision}_{YYYYMMDD}_{description}.py`
- 本番適用: CI/CD パイプラインで自動実行
- ロールバック: `alembic downgrade -1`

---

## 更新履歴

| 日付 | バージョン | 更新者 | 内容 |
|------|-----------|--------|------|
| 2026-02-25 | 1.0.0 | システム管理者 | 初版作成 |
