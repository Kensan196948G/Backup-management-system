# エラーハンドリング仕様書

**プロジェクト名:** バックアップ管理システム WebUI
**バージョン:** 1.0.0
**作成日:** 2026-02-25

---

## 1. エラーハンドリング方針

- ユーザーに対して**原因**と**次のアクション**を明確に伝える
- 技術的な内部エラー情報（スタックトレース等）をユーザーに見せない
- エラーはロールに関係なく一貫した形式で表示する
- エラー発生時はユーザーの入力データを可能な限り保持する

---

## 2. エラーコード定義

### 2.1 認証エラー（AUTH）

| コード | HTTP | メッセージ | 説明 |
|--------|------|----------|------|
| AUTH_001 | 401 | 認証が必要です | 未ログインでアクセス |
| AUTH_002 | 401 | メールアドレスまたはパスワードが正しくありません | 認証情報不一致 |
| AUTH_003 | 401 | セッションの有効期限が切れました | アクセストークン期限切れ |
| AUTH_004 | 401 | ログインし直してください | リフレッシュトークン期限切れ |
| AUTH_005 | 403 | アカウントがロックされています | ロック状態 |
| AUTH_006 | 403 | アカウントが無効です | 無効状態 |

### 2.2 認可エラー（AUTHZ）

| コード | HTTP | メッセージ | 説明 |
|--------|------|----------|------|
| AUTHZ_001 | 403 | この操作を行う権限がありません | ロール不足 |
| AUTHZ_002 | 403 | このリソースへのアクセス権限がありません | リソースへのアクセス拒否 |

### 2.3 バリデーションエラー（VALID）

| コード | HTTP | 説明 |
|--------|------|------|
| VALID_001 | 400 | 必須フィールドが不足 |
| VALID_002 | 400 | フィールドの型・形式が不正 |
| VALID_003 | 400 | フィールドの値が範囲外 |
| VALID_004 | 400 | フィールドの文字数が超過 |
| VALID_005 | 409 | 一意制約違反（重複） |

### 2.4 リソースエラー（RESOURCE）

| コード | HTTP | メッセージ |
|--------|------|----------|
| RESOURCE_001 | 404 | 指定されたジョブが見つかりません |
| RESOURCE_002 | 404 | 指定されたユーザーが見つかりません |
| RESOURCE_003 | 404 | 指定されたレポートが見つかりません |
| RESOURCE_004 | 409 | ジョブは現在実行中です |
| RESOURCE_005 | 409 | ジョブ名は既に使用されています |

### 2.5 システムエラー（SYS）

| コード | HTTP | メッセージ |
|--------|------|----------|
| SYS_001 | 500 | 予期しないエラーが発生しました。しばらく経ってから再試行してください |
| SYS_002 | 503 | サービスが一時的に利用できません |
| SYS_003 | 502 | バックエンドサービスとの接続に失敗しました |
| SYS_004 | 504 | 処理がタイムアウトしました |
| SYS_005 | 429 | リクエスト数が上限を超えました。しばらく経ってから再試行してください |

---

## 3. フロントエンドエラーハンドリング

### 3.1 API エラーの処理（axios インターセプター）

```typescript
// エラー処理の優先順位
1. ネットワークエラー（オフライン）→ 「ネットワーク接続を確認してください」
2. 401 Unauthorized → トークン更新試行 → 失敗時はログイン画面へ
3. 403 Forbidden → 権限エラーメッセージをトースト表示
4. 404 Not Found → 404 ページへ遷移
5. 422 / 400 → フォームのインラインエラーとして表示
6. 429 Too Many Requests → 「しばらく経ってから再試行してください」
7. 5xx → 「予期しないエラーが発生しました」トースト + エラー ID 表示
```

### 3.2 フォームバリデーションエラー

- サーバーからのフィールドエラーを対応するフォームフィールドの下に表示
- 複数フィールドエラーはすべて表示する（1 つだけでなく）
- フォームの送信ボタンは disabled にせず、エラーをクリックで表示する

### 3.3 エラーバウンダリ

```tsx
// ページレベルのエラーバウンダリ
<ErrorBoundary
  fallback={<ErrorPage message="ページの表示中にエラーが発生しました" />}
>
  <RouterOutlet />
</ErrorBoundary>

// コンポーネントレベル（ウィジェット）
<ErrorBoundary
  fallback={<WidgetError message="データの読み込みに失敗しました" />}
>
  <DashboardWidget />
</ErrorBoundary>
```

### 3.4 エラー表示コンポーネント

| 種別 | コンポーネント | 使用場面 |
|------|-------------|---------|
| トースト通知 | `Toast` | 一時的なエラー（API 失敗等） |
| インラインエラー | `FieldError` | フォームバリデーション |
| バナー | `ErrorBanner` | ページレベルの重要なエラー |
| エンプティステート | `EmptyState` | データ取得失敗時のリスト表示 |
| エラーページ | `ErrorPage` | 致命的エラー・404/500 |

---

## 4. バックエンドエラーハンドリング

### 4.1 グローバル例外ハンドラー（FastAPI）

```python
@app.exception_handler(ValidationError)
async def validation_exception_handler(request, exc):
    return JSONResponse(
        status_code=400,
        content={
            "error": {
                "code": "VALIDATION_ERROR",
                "message": "入力値が不正です",
                "details": [
                    {"field": e["loc"][-1], "message": e["msg"]}
                    for e in exc.errors()
                ]
            }
        }
    )
```

### 4.2 エラーログ

| レベル | 対象 |
|-------|------|
| ERROR | 5xx エラー・予期しない例外 |
| WARNING | 4xx エラー（認証失敗含む） |
| INFO | 操作ログ（認証成功等） |

- エラーには Request ID を付与して追跡可能にする
- スタックトレースはサーバーログにのみ記録する（レスポンスに含めない）

---

## 5. オフライン・ネットワークエラー

```
ユーザーがオフライン
  → バナー表示: 「インターネット接続がありません。確認してください。」
  → 進行中の操作をキューに保存
  → 接続回復時にキューを処理
  → 「接続が回復しました」トースト表示
```

---

## 6. 404 / 500 エラーページ

### 404 ページ
- メッセージ: 「ページが見つかりません」
- 説明: 「お探しのページは移動または削除された可能性があります。」
- アクション: 「ダッシュボードへ戻る」ボタン

### 500 ページ
- メッセージ: 「サーバーエラーが発生しました」
- 説明: 「問題が発生しました。しばらく経ってから再試行してください。」
- エラーID: `エラーID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx`（問い合わせ用）
- アクション: 「再読み込み」「ダッシュボードへ戻る」

---

## 更新履歴

| 日付 | バージョン | 更新者 | 内容 |
|------|-----------|--------|------|
| 2026-02-25 | 1.0.0 | システム管理者 | 初版作成 |
