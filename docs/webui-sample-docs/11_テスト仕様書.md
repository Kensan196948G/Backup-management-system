# テスト仕様書

**プロジェクト名:** バックアップ管理システム WebUI
**バージョン:** 1.0.0
**作成日:** 2026-02-25

---

## 1. テスト戦略

### 1.1 テストピラミッド

```
        ┌──────────────────┐
        │   E2E テスト      │  少数・重要フロー
        │   (Playwright)   │
        ├──────────────────┤
        │ 統合テスト         │  API・コンポーネント連携
        │ (Vitest + RTL)   │
        ├──────────────────┤
        │  ユニットテスト    │  関数・コンポーネント単体
        │  (Vitest)        │
        └──────────────────┘
```

### 1.2 テストカバレッジ目標

| レイヤー | カバレッジ目標 |
|---------|-------------|
| ユニットテスト（ユーティリティ・フック） | 90% 以上 |
| 統合テスト（API エンドポイント） | 80% 以上 |
| E2E テスト（重要フロー） | 主要 10 フロー |

---

## 2. フロントエンドテスト

### 2.1 ユニットテスト

**テスト対象:**
- カスタムフック（`useJobs`, `useAuth` 等）
- ユーティリティ関数（日付フォーマット・バリデーション等）
- Zustand ストアアクション
- バリデーションスキーマ（Zod）

**サンプルテストケース:**

```typescript
// useFormatDuration.test.ts
describe('useFormatDuration', () => {
  test('秒数を人間が読みやすい形式に変換する', () => {
    expect(formatDuration(3661)).toBe('1時間1分1秒');
    expect(formatDuration(60)).toBe('1分0秒');
    expect(formatDuration(0)).toBe('0秒');
  });
});
```

### 2.2 コンポーネントテスト（RTL）

**テスト方針:**
- 実装詳細をテストしない（`data-testid` より Accessibility Roles を優先）
- ユーザーの操作（クリック・入力）を軸にテストを記述

**テストケース一覧:**

| コンポーネント | テストケース |
|------------|------------|
| Button | レンダリング・クリック・disabled・loading 状態 |
| DataTable | データ表示・ソート・ページネーション・空状態 |
| JobStatusBadge | 各ステータスのラベル・色の表示 |
| LoginForm | バリデーション・送信・エラー表示 |
| WizardForm | ステップ遷移・バリデーション・送信 |

**サンプル:**
```typescript
test('ジョブ削除ボタンクリックで確認ダイアログが表示される', async () => {
  render(<JobListRow job={mockJob} />);
  await userEvent.click(screen.getByRole('button', { name: '削除' }));
  expect(screen.getByRole('dialog', { name: 'ジョブを削除しますか？' })).toBeInTheDocument();
});
```

---

## 3. バックエンドテスト

### 3.1 API エンドポイントテスト

**テストフレームワーク:** pytest + httpx（FastAPI TestClient）

**テスト構成:**
```
tests/
├── conftest.py          # テスト用 DB・認証フィクスチャ
├── test_auth.py
├── test_jobs.py
├── test_executions.py
├── test_reports.py
└── test_users.py
```

**テストケース一覧:**

| エンドポイント | ケース |
|------------|-------|
| POST /auth/login | 正常ログイン / 無効な認証情報 / ロックされたアカウント |
| GET /jobs | ページネーション / フィルタリング / 権限（role別） |
| POST /jobs | バリデーション成功 / 必須フィールド欠損 / 重複名前 |
| DELETE /jobs/:id | 存在するジョブ / 存在しないジョブ / 権限不足 |
| POST /jobs/:id/run | 即時実行 / 既に実行中のジョブ |

**サンプル:**
```python
def test_login_success(client, db_session):
    response = client.post("/api/v1/auth/login", json={
        "email": "admin@example.com",
        "password": "P@ssw0rd123!"
    })
    assert response.status_code == 200
    assert "access_token" in response.json()["data"]

def test_login_invalid_credentials(client):
    response = client.post("/api/v1/auth/login", json={
        "email": "admin@example.com",
        "password": "wrong"
    })
    assert response.status_code == 401
    assert response.json()["error"]["code"] == "INVALID_CREDENTIALS"
```

---

## 4. E2E テスト

### 4.1 主要テストシナリオ

| No. | シナリオ名 | 説明 |
|-----|----------|------|
| E2E-001 | ログイン・ログアウト | 正常ログイン → ダッシュボード表示 → ログアウト |
| E2E-002 | ジョブ作成フロー | ウィザード全ステップを経てジョブを作成する |
| E2E-003 | ジョブ即時実行 | ジョブ一覧から即時実行 → 進捗確認 |
| E2E-004 | レポート生成・ダウンロード | 日次レポートを PDF でダウンロード |
| E2E-005 | ユーザー管理（Admin） | 新規ユーザー作成 → ロール変更 → 削除 |
| E2E-006 | 認証エラー | 無効な認証情報でログイン失敗 |
| E2E-007 | 権限拒否 | Viewer ロールでジョブ作成ページへアクセス拒否 |
| E2E-008 | ダッシュボード表示 | サマリーカード・タイムラインが正しく表示される |
| E2E-009 | セッションタイムアウト | 60 分アイドル後に自動ログアウト |
| E2E-010 | 検索・フィルタ | ジョブ一覧でフィルタリング・ソートが機能する |

### 4.2 テスト環境

- **ブラウザ:** Chromium（必須）/ Firefox（任意）/ WebKit（任意）
- **実行環境:** CI（GitHub Actions）でヘッドレス実行
- **データ:** テスト専用 DB（本番データを使用しない）

---

## 5. パフォーマンステスト

**ツール:** k6

**シナリオ:**

| テスト種別 | 設定 | 合格基準 |
|----------|------|---------|
| 負荷テスト | 100 仮想ユーザー × 10 分 | p95 < 500ms、エラー率 < 1% |
| スパイクテスト | 0→500VU を 30 秒で増加 | エラー率 < 5% |
| ソークテスト | 50VU × 2 時間 | p95 < 1000ms、メモリリーク無し |

---

## 6. アクセシビリティテスト

**ツール:** axe-core（RTL + Playwright に統合）

**チェック項目:**
- キーボードナビゲーション（全操作が Tab / Enter / Esc で実行可能）
- スクリーンリーダー対応（適切な ARIA 属性）
- カラーコントラスト比（WCAG AA 基準：4.5:1 以上）
- フォーカスインジケーターの視認性

---

## 7. セキュリティテスト

- OWASP ZAP による動的スキャン（ステージング環境）
- npm audit / safety による依存関係チェック（CI 統合）
- 認証・認可のペネトレーションテスト（年次）

---

## 更新履歴

| 日付 | バージョン | 更新者 | 内容 |
|------|-----------|--------|------|
| 2026-02-25 | 1.0.0 | システム管理者 | 初版作成 |
