# デプロイメント仕様書

**プロジェクト名:** バックアップ管理システム WebUI
**バージョン:** 1.0.0
**作成日:** 2026-02-25

---

## 1. 環境定義

| 環境 | 用途 | URL | ブランチ |
|------|------|-----|--------|
| Development | 開発・デバッグ | `http://localhost:5173` | `feature/*` |
| Staging | テスト・検証 | `https://staging-backup-mgmt.example.com` | `develop` |
| Production | 本番 | `https://backup-mgmt.example.com` | `main` |

---

## 2. システム要件

### 2.1 サーバー要件（本番）

| コンポーネント | 最小スペック | 推奨スペック |
|------------|-----------|-----------|
| アプリケーションサーバー | 4 vCPU / 8GB RAM | 8 vCPU / 16GB RAM |
| データベースサーバー | 4 vCPU / 8GB RAM | 8 vCPU / 32GB RAM |
| Redis | 2 vCPU / 4GB RAM | 4 vCPU / 8GB RAM |
| OS | Ubuntu 22.04 LTS | Ubuntu 22.04 LTS |
| ストレージ（OS + アプリ） | 100GB SSD | 200GB SSD |

### 2.2 ネットワーク要件

| ポート | 用途 | 方向 |
|--------|------|------|
| 443 | HTTPS | インバウンド |
| 80 | HTTP（HTTPSへリダイレクト） | インバウンド |
| 5432 | PostgreSQL | 内部のみ |
| 6379 | Redis | 内部のみ |
| 8000 | FastAPI（内部） | 内部のみ |

---

## 3. コンテナ構成

### 3.1 docker-compose.yml（本番）

```yaml
version: '3.9'
services:
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - frontend_dist:/usr/share/nginx/html:ro
    depends_on:
      - backend

  backend:
    build:
      context: ./backend
      target: production
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - SECRET_KEY=${SECRET_KEY}
      - ENVIRONMENT=production
    expose:
      - "8000"
    depends_on:
      - db
      - redis
    restart: unless-stopped

  celery:
    build:
      context: ./backend
      target: production
    command: celery -A app.celery worker --loglevel=info
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
    depends_on:
      - db
      - redis
    restart: unless-stopped

  celery-beat:
    build:
      context: ./backend
      target: production
    command: celery -A app.celery beat --loglevel=info
    depends_on:
      - redis
    restart: unless-stopped

  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  frontend_dist:
```

---

## 4. CI/CD パイプライン

### 4.1 GitHub Actions ワークフロー

```
push to feature/* ──→ [CI] lint + test + build
push to develop   ──→ [CI] + [CD: Staging デプロイ]
push to main      ──→ [CI] + [CD: Production デプロイ（承認必要）]
```

### 4.2 CI ジョブ（全環境）

1. **lint** — ESLint / ruff
2. **type-check** — TypeScript / mypy
3. **unit-test** — Vitest / pytest
4. **integration-test** — Playwright（staging 環境）
5. **security-scan** — npm audit / safety / trivy
6. **build** — Docker イメージビルド

### 4.3 デプロイ手順（本番）

```bash
# 1. 本番ブランチへのマージ（GitHub PR + 承認）
# 2. GitHub Actions が自動でビルド・プッシュ
# 3. Staging での自動 E2E テスト
# 4. 本番デプロイの手動承認
# 5. ローリングアップデート実行

# 手動デプロイ（緊急時）
ssh deploy@backup-mgmt.example.com
cd /opt/backup-management
git pull origin main
docker compose pull
docker compose up -d --no-deps --build backend
docker compose exec backend alembic upgrade head
```

---

## 5. 環境変数

### 5.1 必須環境変数

| 変数名 | 説明 | 例 |
|--------|------|-----|
| `SECRET_KEY` | JWT 署名鍵（最小 32 文字のランダム文字列） | `openssl rand -hex 32` で生成 |
| `DATABASE_URL` | PostgreSQL 接続文字列 | `postgresql+asyncpg://user:pass@db:5432/dbname` |
| `REDIS_URL` | Redis 接続文字列 | `redis://:password@redis:6379/0` |
| `ALLOWED_ORIGINS` | CORS 許可オリジン | `https://backup-mgmt.example.com` |

### 5.2 オプション環境変数

| 変数名 | デフォルト | 説明 |
|--------|----------|------|
| `ACCESS_TOKEN_EXPIRE_MINUTES` | `15` | アクセストークン有効期限（分） |
| `REFRESH_TOKEN_EXPIRE_DAYS` | `7` | リフレッシュトークン有効期限（日） |
| `MAX_LOGIN_ATTEMPTS` | `5` | 最大ログイン試行回数 |
| `SMTP_HOST` | - | メール送信サーバー |
| `LOG_LEVEL` | `info` | ログレベル |

---

## 6. ヘルスチェック

| エンドポイント | 説明 | 期待レスポンス |
|------------|------|--------------|
| `GET /health` | アプリ生存確認 | `200 {"status": "ok"}` |
| `GET /health/ready` | 依存サービス確認 | `200 {"db": "ok", "redis": "ok"}` |

---

## 7. ロールバック手順

```bash
# 前バージョンのイメージを確認
docker images | grep backup-backend

# ロールバック
docker compose up -d --no-deps backend=backup-backend:v1.0.0

# DB マイグレーションのロールバック（必要な場合）
docker compose exec backend alembic downgrade -1
```

---

## 更新履歴

| 日付 | バージョン | 更新者 | 内容 |
|------|-----------|--------|------|
| 2026-02-25 | 1.0.0 | システム管理者 | 初版作成 |
