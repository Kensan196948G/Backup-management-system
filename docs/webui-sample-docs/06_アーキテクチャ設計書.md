# アーキテクチャ設計書

**プロジェクト名:** バックアップ管理システム WebUI
**バージョン:** 1.0.0
**作成日:** 2026-02-25

---

## 1. システム全体アーキテクチャ

### 1.1 アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────────┐
│                     クライアント層                            │
│   ┌─────────────────────────────────────────────────────┐   │
│   │              React SPA (ブラウザ)                    │   │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────────────┐  │   │
│   │  │ Pages    │  │Components│  │  State (Zustand)  │  │   │
│   │  │ /Router  │  │ Library  │  │  + React Query   │  │   │
│   │  └──────────┘  └──────────┘  └──────────────────┘  │   │
│   └─────────────────────┬────────────────────────────────┘   │
└─────────────────────────│───────────────────────────────────┘
                          │ HTTPS / WebSocket
┌─────────────────────────▼───────────────────────────────────┐
│                     サービス層                                │
│   ┌───────────────────────────────────────────────────┐     │
│   │           Nginx リバースプロキシ                     │     │
│   └──────────┬──────────────────────────────┬──────────┘     │
│              │                              │                 │
│   ┌──────────▼──────────┐      ┌───────────▼──────────┐     │
│   │  FastAPI バックエンド │      │  WebSocket サーバー   │     │
│   │  (REST API)         │      │  (リアルタイム更新)    │     │
│   └──────────┬──────────┘      └───────────┬──────────┘     │
└──────────────│──────────────────────────────│────────────────┘
               │                              │
┌──────────────▼──────────────────────────────▼────────────────┐
│                     データ層                                   │
│   ┌──────────────┐  ┌──────────────┐  ┌───────────────────┐  │
│   │ PostgreSQL   │  │    Redis     │  │   File Storage    │  │
│   │ (メインDB)   │  │  (キャッシュ) │  │  (バックアップ先)  │  │
│   └──────────────┘  └──────────────┘  └───────────────────┘  │
└──────────────────────────────────────────────────────────────┘
```

---

## 2. フロントエンドアーキテクチャ

### 2.1 技術スタック

| レイヤー | 技術 | バージョン | 役割 |
|---------|------|----------|------|
| フレームワーク | React | 18.x | UI ライブラリ |
| 言語 | TypeScript | 5.x | 型安全な開発 |
| ビルドツール | Vite | 5.x | 高速ビルド / HMR |
| ルーティング | React Router | 6.x | クライアントサイドルーティング |
| 状態管理（サーバー） | TanStack Query | 5.x | API キャッシュ・同期 |
| 状態管理（クライアント） | Zustand | 4.x | グローバルUIステート |
| HTTP クライアント | Axios | 1.x | API 通信 |
| スタイリング | Tailwind CSS | 3.x | ユーティリティ CSS |
| フォーム | React Hook Form | 7.x | フォーム管理 |
| バリデーション | Zod | 3.x | スキーマバリデーション |
| チャート | Recharts | 2.x | データ可視化 |
| テスト | Vitest + RTL | - | ユニット / 統合テスト |
| E2E テスト | Playwright | - | E2E テスト |

### 2.2 ディレクトリ構成

```
src/
├── assets/              # 静的ファイル（画像・フォント）
├── components/          # 再利用可能コンポーネント
│   ├── atoms/
│   ├── molecules/
│   ├── organisms/
│   └── templates/
├── features/            # 機能別モジュール
│   ├── auth/
│   │   ├── components/
│   │   ├── hooks/
│   │   ├── store/
│   │   └── api/
│   ├── dashboard/
│   ├── jobs/
│   ├── reports/
│   └── settings/
├── hooks/               # カスタムフック
├── lib/                 # ユーティリティ・設定
│   ├── api.ts           # Axios インスタンス
│   ├── i18n.ts          # 国際化設定
│   └── utils.ts         # 共通ユーティリティ
├── pages/               # ページコンポーネント
├── router/              # ルーティング設定
├── store/               # グローバルストア
├── types/               # TypeScript 型定義
└── main.tsx             # エントリーポイント
```

### 2.3 状態管理戦略

| データ種別 | 管理方法 | 理由 |
|-----------|---------|------|
| サーバーデータ | TanStack Query | キャッシュ・再取得・楽観的更新 |
| UI 状態（モーダル等） | Zustand | シンプルなグローバルUI管理 |
| フォームデータ | React Hook Form | フォーム特化・パフォーマンス |
| URL 状態（フィルタ等） | URL Params | 共有可能・戻るボタン対応 |
| リアルタイムデータ | WebSocket + TanStack Query | リアルタイム + キャッシュ統合 |

---

## 3. バックエンドアーキテクチャ

### 3.1 技術スタック

| レイヤー | 技術 | バージョン |
|---------|------|----------|
| フレームワーク | FastAPI | 0.110+ |
| 言語 | Python | 3.12 |
| ORM | SQLAlchemy | 2.x |
| マイグレーション | Alembic | - |
| バリデーション | Pydantic | 2.x |
| 認証 | python-jose (JWT) | - |
| タスクキュー | Celery + Redis | - |
| WebSocket | FastAPI WebSocket | - |

### 3.2 レイヤードアーキテクチャ

```
API エンドポイント（Router）
    ↓ リクエスト検証（Pydantic Schema）
    ↓ 認証・認可（JWT Middleware）
サービス層（Business Logic）
    ↓ データアクセス
リポジトリ層（Repository Pattern）
    ↓
データベース層（SQLAlchemy Models）
```

---

## 4. インフラアーキテクチャ

### 4.1 Docker Compose 構成（開発）

```yaml
services:
  frontend:    # React dev server (Vite)
  backend:     # FastAPI
  db:          # PostgreSQL 15
  redis:       # Redis 7
  nginx:       # リバースプロキシ
  celery:      # バックグラウンドジョブ
```

### 4.2 本番構成

- コンテナオーケストレーション: Docker Compose（スタンドアロン） or Kubernetes
- フロントエンド: Nginx でビルド済み静的ファイルを配信
- SSL 終端: Nginx（Let's Encrypt or 社内 CA）
- バックアップデータ: NFS / S3 互換オブジェクトストレージ

---

## 5. セキュリティアーキテクチャ

### 5.1 認証フロー

```
クライアント → POST /api/auth/login
                ↓
           バックエンド: パスワード検証（bcrypt）
                ↓
           JWT Access Token（有効期限 15 分）+ Refresh Token（7 日）発行
                ↓
クライアント: Access Token をメモリ（Zustand）に保存
            Refresh Token を HttpOnly Cookie に保存
                ↓
API リクエスト: Authorization: Bearer {access_token}
                ↓
Access Token 期限切れ → Refresh Token で自動更新
```

### 5.2 CORS 設定

- 許可オリジン: 環境変数で管理（本番は特定ドメインのみ）
- 許可メソッド: GET, POST, PUT, PATCH, DELETE, OPTIONS
- 許可ヘッダー: Content-Type, Authorization
- Credentials: true（Cookie 送受信のため）

---

## 更新履歴

| 日付 | バージョン | 更新者 | 内容 |
|------|-----------|--------|------|
| 2026-02-25 | 1.0.0 | システム管理者 | 初版作成 |
