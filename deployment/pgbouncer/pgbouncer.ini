;; PgBouncer設定ファイル
;; Phase 13: 接続プーリング
;;
;; インストール:
;;   sudo apt install pgbouncer
;;
;; 配置場所:
;;   sudo cp deployment/pgbouncer/pgbouncer.ini /etc/pgbouncer/pgbouncer.ini
;;   sudo cp deployment/pgbouncer/userlist.txt /etc/pgbouncer/userlist.txt
;;   sudo chmod 640 /etc/pgbouncer/userlist.txt
;;   sudo chown postgres:postgres /etc/pgbouncer/*.txt
;;
;; 起動:
;;   sudo systemctl restart pgbouncer
;;   sudo systemctl enable pgbouncer

[databases]
;; データベース定義
;; 形式: dbname = host=hostname port=port dbname=database_name
backup_management = host=localhost port=5434 dbname=backup_management

;; フォールバック用
* = host=localhost port=5434

[pgbouncer]
;;;
;;; 管理設定
;;;

;; リスニングアドレス
listen_addr = 127.0.0.1, 192.168.3.135
listen_port = 6432

;; Unixソケット
unix_socket_dir = /var/run/postgresql
unix_socket_mode = 0777

;;;
;;; 認証
;;;

;; 認証方式
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

;; 管理ユーザー
;; admin_users = postgres
;; stats_users = postgres

;;;
;;; プーリング設定
;;;

;; プーリングモード
;; session: 接続単位（デフォルト、安全）
;; transaction: トランザクション単位（高パフォーマンス、推奨）
;; statement: ステートメント単位（高度な使用のみ）
pool_mode = transaction

;; 接続数制限
max_client_conn = 100            ;; クライアントからの最大接続数
default_pool_size = 25           ;; DB接続プールサイズ（通常時）
min_pool_size = 5                ;; 最小プールサイズ
reserve_pool_size = 5            ;; 予約プール
reserve_pool_timeout = 5         ;; 予約プールタイムアウト（秒）
max_db_connections = 50          ;; DBへの最大接続数
max_user_connections = 100       ;; ユーザーあたり最大接続数

;;;
;;; タイムアウト設定
;;;

;; サーバー側タイムアウト
server_idle_timeout = 600        ;; アイドル接続のタイムアウト（秒）
server_lifetime = 3600           ;; 接続の最大生存時間（秒）
server_connect_timeout = 15      ;; 接続確立タイムアウト（秒）

;; クライアント側タイムアウト
client_idle_timeout = 0          ;; クライアントアイドルタイムアウト（0=無効）
client_login_timeout = 60        ;; ログインタイムアウト（秒）

;; クエリタイムアウト
query_timeout = 0                ;; クエリタイムアウト（0=無効）
query_wait_timeout = 120         ;; クエリ待機タイムアウト（秒）

;;;
;;; ログ設定
;;;

;; ログファイル
logfile = /var/log/postgresql/pgbouncer.log
pidfile = /var/run/postgresql/pgbouncer.pid

;; ログレベル
;; 0 - quiet, 1 - normal, 2 - verbose
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1

;; 統計情報
stats_period = 60                ;; 統計更新間隔（秒）

;;;
;;; パフォーマンス設定
;;;

;; DNS設定
dns_max_ttl = 15
dns_nxdomain_ttl = 15

;; TCPキープアライブ
tcp_keepalive = 1
tcp_keepcnt = 5
tcp_keepidle = 60
tcp_keepintvl = 15

;; パケット設定
pkt_buf = 4096
max_packet_size = 2147483647
tcp_defer_accept = 0

;;;
;;; セキュリティ
;;;

;; 安全でない機能の無効化
disable_pqexec = 0
application_name_add_host = 1

;; ============================================================
;; 管理コンソール
;; ============================================================
;;
;; PgBouncer管理コンソールアクセス方法:
;;   psql -h 127.0.0.1 -p 6432 -U backupmgmt pgbouncer
;;
;; 管理コマンド:
;;   SHOW POOLS;           - プール状態表示
;;   SHOW CLIENTS;         - クライアント一覧
;;   SHOW SERVERS;         - サーバー接続一覧
;;   SHOW STATS;           - 統計情報
;;   RELOAD;               - 設定リロード
;;   PAUSE;                - 一時停止
;;   RESUME;               - 再開
;;   SHUTDOWN;             - シャットダウン
