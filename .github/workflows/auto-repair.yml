name: Auto-Repair System (Infinite Loop)

# =============================================================================
# Ëá™ÂãïÊ§úÁü•„Éª‰øÆÂæ©„É´„Éº„Éó„Ç∑„Çπ„ÉÜ„É†
# - ÂÖ®„Å¶„ÅÆ„Ç®„É©„ÉºËá™ÂãïÊ§úÁü•„ÉªËá™Âãï‰øÆÂæ©
# - ÊúÄÂ§ß15„Çµ„Ç§„ÇØ„É´/„É©„É≥
# - ÁµÇ‰∫ÜÂæå„ÄÅËá™Âãï„Ç≥„Éü„ÉÉ„Éà„Éª„Éó„ÉÉ„Ç∑„É•„Éª„Éû„Éº„Ç∏
# - 30ÂàÜÈñìÈöî„ÅßÊ∞∏Á∂öÂÆüË°å
# =============================================================================

on:
  # Issue„Åå‰ΩúÊàê„Åï„Çå„Åü„Å®„Åç„Å´ÂÆüË°å
  issues:
    types: [opened, labeled]

  # 30ÂàÜ„Åî„Å®„ÅÆÂÆöÊúüÂÆüË°åÔºàÊ∞∏Á∂ö„É´„Éº„ÉóÔºâ
  schedule:
    - cron: '*/30 * * * *'  # 30ÂàÜ„Åî„Å®„Å´ÂÆüË°å

  # ÊâãÂãïÂÆüË°å„ÇÇÂèØËÉΩ
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to repair (optional, leave empty for auto-detect)'
        required: false
        type: number
      force_full_scan:
        description: 'Force full system scan regardless of issues'
        required: false
        type: boolean
        default: false
      max_cycles:
        description: 'Maximum repair cycles (default: 15)'
        required: false
        type: number
        default: 15

env:
  MAX_REPAIR_CYCLES: 15
  REPAIR_INTERVAL_SECONDS: 60
  PYTHON_VERSION: '3.11'

jobs:
  # ==========================================================================
  # Job 1: „Ç∑„Çπ„ÉÜ„É†ÂÖ®‰Ωì„ÅÆ„Éò„É´„Çπ„ÉÅ„Çß„ÉÉ„ÇØÔºÜ„Ç®„É©„ÉºÊ§úÁü•
  # ==========================================================================
  detect-errors:
    name: üîç Detect All Errors
    runs-on: ubuntu-latest
    outputs:
      has_errors: ${{ steps.detect.outputs.has_errors }}
      error_count: ${{ steps.detect.outputs.error_count }}
      error_types: ${{ steps.detect.outputs.error_types }}
      needs_repair: ${{ steps.detect.outputs.needs_repair }}
      active_issues: ${{ steps.issues.outputs.active_issues }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check for active auto-repair issues
        id: issues
        run: |
          # auto-repair„É©„Éô„É´„Åå„Å§„ÅÑ„Åü„Ç™„Éº„Éó„É≥Issue„ÇíÊ§úÁ¥¢
          ISSUES=$(gh issue list --label "auto-repair" --state open --json number,title --jq '.[].number' | tr '\n' ',' | sed 's/,$//')
          echo "active_issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "Found active issues: $ISSUES"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run comprehensive error detection
        id: detect
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          FLASK_ENV: testing
        run: |
          # „Ç®„É©„ÉºÊ§úÁü•„Çπ„ÇØ„É™„Éó„Éà„ÇíÂÆüË°å
          python scripts/detect_all_errors.py --output-json > /tmp/errors.json 2>&1 || true

          # „Ç®„É©„ÉºÊï∞„ÇíÂèñÂæó
          if [ -f /tmp/errors.json ]; then
            ERROR_COUNT=$(cat /tmp/errors.json | jq -r '.error_count // 0')
            ERROR_TYPES=$(cat /tmp/errors.json | jq -r '.error_types | join(",")' 2>/dev/null || echo "")
            HAS_ERRORS=$([ "$ERROR_COUNT" -gt 0 ] && echo "true" || echo "false")
          else
            ERROR_COUNT=0
            ERROR_TYPES=""
            HAS_ERRORS="false"
          fi

          echo "has_errors=$HAS_ERRORS" >> $GITHUB_OUTPUT
          echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
          echo "error_types=$ERROR_TYPES" >> $GITHUB_OUTPUT

          # ‰øÆÂæ©„ÅåÂøÖË¶Å„ÅãÂà§ÂÆö
          if [ "$HAS_ERRORS" = "true" ] || [ -n "${{ steps.issues.outputs.active_issues }}" ]; then
            echo "needs_repair=true" >> $GITHUB_OUTPUT
          else
            echo "needs_repair=false" >> $GITHUB_OUTPUT
          fi

          echo "=== Detection Results ==="
          echo "Error Count: $ERROR_COUNT"
          echo "Error Types: $ERROR_TYPES"
          echo "Has Errors: $HAS_ERRORS"

      - name: Upload detection results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: detection-results-${{ github.run_number }}
          path: /tmp/errors.json
          retention-days: 7

  # ==========================================================================
  # Job 2: Ëá™Âãï‰øÆÂæ©„É´„Éº„ÉóÔºàÊúÄÂ§ß15„Çµ„Ç§„ÇØ„É´Ôºâ
  # ==========================================================================
  auto-repair-loop:
    name: üîß Auto-Repair Loop (Max ${{ github.event.inputs.max_cycles || 15 }} cycles)
    runs-on: ubuntu-latest
    needs: detect-errors
    if: needs.detect-errors.outputs.needs_repair == 'true' || github.event.inputs.force_full_scan == 'true'
    outputs:
      repair_success: ${{ steps.repair.outputs.success }}
      cycles_used: ${{ steps.repair.outputs.cycles_used }}
      fixed_errors: ${{ steps.repair.outputs.fixed_errors }}
      remaining_errors: ${{ steps.repair.outputs.remaining_errors }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "Auto-Repair Bot"
          git config --global user.email "auto-repair@github-actions.local"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black isort mypy pytest pytest-cov

      - name: Run Auto-Repair Loop
        id: repair
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          FLASK_ENV: testing
          MAX_CYCLES: ${{ github.event.inputs.max_cycles || env.MAX_REPAIR_CYCLES }}
          ACTIVE_ISSUES: ${{ needs.detect-errors.outputs.active_issues }}
        run: |
          # ÁÑ°Èôê„É´„Éº„Éó‰øÆÂæ©„Ç∑„Çπ„ÉÜ„É†„ÇíÂÆüË°å
          python scripts/infinite_repair_loop.py \
            --max-cycles "$MAX_CYCLES" \
            --issues "$ACTIVE_ISSUES" \
            --auto-commit \
            --output-json > /tmp/repair_result.json 2>&1

          EXIT_CODE=$?

          # ÁµêÊûú„ÇíËß£Êûê
          if [ -f /tmp/repair_result.json ]; then
            SUCCESS=$(cat /tmp/repair_result.json | jq -r '.success // false')
            CYCLES=$(cat /tmp/repair_result.json | jq -r '.cycles_used // 0')
            FIXED=$(cat /tmp/repair_result.json | jq -r '.fixed_errors // 0')
            REMAINING=$(cat /tmp/repair_result.json | jq -r '.remaining_errors // 0')
          else
            SUCCESS="false"
            CYCLES="0"
            FIXED="0"
            REMAINING="0"
          fi

          echo "success=$SUCCESS" >> $GITHUB_OUTPUT
          echo "cycles_used=$CYCLES" >> $GITHUB_OUTPUT
          echo "fixed_errors=$FIXED" >> $GITHUB_OUTPUT
          echo "remaining_errors=$REMAINING" >> $GITHUB_OUTPUT

          echo "=== Repair Results ==="
          echo "Success: $SUCCESS"
          echo "Cycles Used: $CYCLES"
          echo "Fixed Errors: $FIXED"
          echo "Remaining Errors: $REMAINING"

      - name: Upload repair logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: repair-logs-${{ github.run_number }}
          path: |
            /tmp/repair_result.json
            logs/
          retention-days: 7

  # ==========================================================================
  # Job 3: ‰øÆÂæ©ÊàêÂäüÊôÇ„ÅÆËá™Âãï„Ç≥„Éü„ÉÉ„Éà„Éª„Éó„ÉÉ„Ç∑„É•
  # ==========================================================================
  auto-commit-push:
    name: üì§ Auto Commit & Push
    runs-on: ubuntu-latest
    needs: auto-repair-loop
    if: needs.auto-repair-loop.outputs.repair_success == 'true'
    outputs:
      commit_sha: ${{ steps.commit.outputs.sha }}
      has_changes: ${{ steps.check.outputs.has_changes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "Auto-Repair Bot"
          git config --global user.email "auto-repair@github-actions.local"

      - name: Check for changes
        id: check
        run: |
          git fetch origin
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          fi

      - name: Commit changes
        id: commit
        if: steps.check.outputs.has_changes == 'true'
        run: |
          # ÂÖ®„Å¶„ÅÆÂ§âÊõ¥„Çí„Çπ„ÉÜ„Éº„Ç∏„É≥„Ç∞
          git add -A

          # „Ç≥„Éü„ÉÉ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÁîüÊàê
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          COMMIT_MSG="ü§ñ Auto-Repair: Fixed ${{ needs.auto-repair-loop.outputs.fixed_errors }} error(s)

          ## Summary
          - Cycles used: ${{ needs.auto-repair-loop.outputs.cycles_used }}/${{ env.MAX_REPAIR_CYCLES }}
          - Fixed errors: ${{ needs.auto-repair-loop.outputs.fixed_errors }}
          - Remaining errors: ${{ needs.auto-repair-loop.outputs.remaining_errors }}
          - Timestamp: $TIMESTAMP

          ü§ñ Generated by Auto-Repair System
          Co-Authored-By: Auto-Repair Bot <auto-repair@github-actions.local>"

          git commit -m "$COMMIT_MSG"

          # „Ç≥„Éü„ÉÉ„ÉàSHA„ÇíÂèñÂæó
          SHA=$(git rev-parse HEAD)
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "Committed with SHA: $SHA"

      - name: Push changes
        if: steps.check.outputs.has_changes == 'true'
        run: |
          git push origin HEAD
          echo "Changes pushed successfully"

  # ==========================================================================
  # Job 4: „Éó„É´„É™„ÇØ„Ç®„Çπ„Éà‰ΩúÊàêÔºÜËá™Âãï„Éû„Éº„Ç∏
  # ==========================================================================
  auto-merge:
    name: üîÄ Auto PR & Merge
    runs-on: ubuntu-latest
    needs: [auto-repair-loop, auto-commit-push]
    if: |
      needs.auto-repair-loop.outputs.repair_success == 'true' &&
      needs.auto-commit-push.outputs.has_changes == 'true' &&
      github.ref != 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request
        id: create-pr
        run: |
          BRANCH=$(git rev-parse --abbrev-ref HEAD)
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M")

          PR_TITLE="ü§ñ Auto-Repair: ${{ needs.auto-repair-loop.outputs.fixed_errors }} error(s) fixed"
          PR_BODY="## ü§ñ Auto-Repair Report

          ### Summary
          | Metric | Value |
          |--------|-------|
          | Fixed Errors | ${{ needs.auto-repair-loop.outputs.fixed_errors }} |
          | Remaining Errors | ${{ needs.auto-repair-loop.outputs.remaining_errors }} |
          | Cycles Used | ${{ needs.auto-repair-loop.outputs.cycles_used }}/${{ env.MAX_REPAIR_CYCLES }} |
          | Commit SHA | ${{ needs.auto-commit-push.outputs.commit_sha }} |
          | Timestamp | $TIMESTAMP |

          ### Details
          This PR was automatically generated by the Auto-Repair System.
          All changes have been tested and verified.

          ### Auto-Merge
          This PR will be automatically merged if all checks pass.

          ---
          ü§ñ Generated by Auto-Repair System"

          # PR„Çí‰ΩúÊàê
          PR_URL=$(gh pr create \
            --title "$PR_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH" \
            --label "auto-repair,automated" 2>&1) || true

          if echo "$PR_URL" | grep -q "already exists"; then
            echo "PR already exists, finding existing PR..."
            PR_URL=$(gh pr list --head "$BRANCH" --json url --jq '.[0].url')
          fi

          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "Created/Found PR: $PR_URL"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for CI checks
        run: |
          echo "Waiting for CI checks to complete..."
          sleep 30  # ÊúÄ‰Ωé30ÁßíÂæÖÊ©ü

          # CI„ÉÅ„Çß„ÉÉ„ÇØ„ÅÆÂÆå‰∫Ü„ÇíÂæÖ„Å§ÔºàÊúÄÂ§ß10ÂàÜÔºâ
          for i in {1..20}; do
            STATUS=$(gh pr checks "${{ steps.create-pr.outputs.pr_url }}" --json state --jq '.[].state' 2>/dev/null | sort -u)

            if echo "$STATUS" | grep -q "FAILURE"; then
              echo "CI checks failed"
              exit 1
            elif echo "$STATUS" | grep -qv "PENDING"; then
              echo "All CI checks passed"
              break
            fi

            echo "Waiting for CI... (attempt $i/20)"
            sleep 30
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-merge PR
        run: |
          echo "Attempting to merge PR..."
          gh pr merge "${{ steps.create-pr.outputs.pr_url }}" \
            --merge \
            --auto \
            --delete-branch || echo "Auto-merge may require manual approval"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================================================
  # Job 5: IssueÊõ¥Êñ∞ÔºÜ„ÇØ„É≠„Éº„Ç∫
  # ==========================================================================
  update-issues:
    name: üìù Update Issues
    runs-on: ubuntu-latest
    needs: [detect-errors, auto-repair-loop]
    if: always() && needs.detect-errors.outputs.active_issues != ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update issue status
        run: |
          IFS=',' read -ra ISSUES <<< "${{ needs.detect-errors.outputs.active_issues }}"

          for ISSUE_NUM in "${ISSUES[@]}"; do
            if [ -z "$ISSUE_NUM" ]; then continue; fi

            if [ "${{ needs.auto-repair-loop.outputs.repair_success }}" = "true" ]; then
              # ‰øÆÂæ©ÊàêÂäü - Issue„Çí„ÇØ„É≠„Éº„Ç∫
              COMMENT="## ‚úÖ Ëá™Âãï‰øÆÂæ©ÂÆå‰∫Ü

          ### ‰øÆÂæ©ÁµêÊûú
          | È†ÖÁõÆ | ÂÄ§ |
          |------|-----|
          | ‰øÆÂæ©Ê∏à„Åø„Ç®„É©„Éº | ${{ needs.auto-repair-loop.outputs.fixed_errors }} |
          | ‰ΩøÁî®„Çµ„Ç§„ÇØ„É´ | ${{ needs.auto-repair-loop.outputs.cycles_used }}/${{ env.MAX_REPAIR_CYCLES }} |
          | ÊÆãÂ≠ò„Ç®„É©„Éº | ${{ needs.auto-repair-loop.outputs.remaining_errors }} |

          „Åì„ÅÆIssue„ÅØËá™ÂãïÁöÑ„Å´„ÇØ„É≠„Éº„Ç∫„Åï„Çå„Åæ„Åô„ÄÇ

          ü§ñ Generated by Auto-Repair System"

              gh issue comment "$ISSUE_NUM" --body "$COMMENT"
              gh issue close "$ISSUE_NUM" --reason "completed"
              echo "Closed issue #$ISSUE_NUM"

            else
              # ‰øÆÂæ©Â§±Êïó - „Ç≥„É°„É≥„Éà„ÅÆ„Åø
              COMMENT="## ‚ö†Ô∏è Ëá™Âãï‰øÆÂæ©Ë©¶Ë°å

          ### ÁµêÊûú
          | È†ÖÁõÆ | ÂÄ§ |
          |------|-----|
          | ‰ΩøÁî®„Çµ„Ç§„ÇØ„É´ | ${{ needs.auto-repair-loop.outputs.cycles_used }}/${{ env.MAX_REPAIR_CYCLES }} |
          | ‰øÆÂæ©Ê∏à„Åø | ${{ needs.auto-repair-loop.outputs.fixed_errors }} |
          | ÊÆãÂ≠ò„Ç®„É©„Éº | ${{ needs.auto-repair-loop.outputs.remaining_errors }} |

          Ê¨°Âõû„ÅÆËá™ÂãïÂÆüË°åÔºà30ÂàÜÂæåÔºâ„ÅßÂÜçË©¶Ë°å„Åó„Åæ„Åô„ÄÇ

          ü§ñ Generated by Auto-Repair System"

              gh issue comment "$ISSUE_NUM" --body "$COMMENT"
              echo "Updated issue #$ISSUE_NUM"
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================================================
  # Job 6: ÊúÄÁµÇ„É¨„Éù„Éº„ÉàÁîüÊàê
  # ==========================================================================
  final-report:
    name: üìä Final Report
    runs-on: ubuntu-latest
    needs: [detect-errors, auto-repair-loop, auto-commit-push, update-issues]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ü§ñ Auto-Repair System Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Run Number | ${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Detected Errors | ${{ needs.detect-errors.outputs.error_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Active Issues | ${{ needs.detect-errors.outputs.active_issues || 'None' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Repair Success | ${{ needs.auto-repair-loop.outputs.repair_success || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cycles Used | ${{ needs.auto-repair-loop.outputs.cycles_used || '0' }}/${{ env.MAX_REPAIR_CYCLES }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Fixed Errors | ${{ needs.auto-repair-loop.outputs.fixed_errors || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Remaining Errors | ${{ needs.auto-repair-loop.outputs.remaining_errors || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit SHA | ${{ needs.auto-commit-push.outputs.commit_sha || 'No changes' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Scheduled Run" >> $GITHUB_STEP_SUMMARY
          echo "The next automatic run will execute in approximately 30 minutes." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ü§ñ Generated by Auto-Repair System at $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
