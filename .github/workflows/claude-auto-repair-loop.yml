name: Claude Auto Repair Loop

on:
  # PRä½œæˆæ™‚ãƒ»æ›´æ–°æ™‚ã«å®Ÿè¡Œ
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushæ™‚ã«å®Ÿè¡Œ
  push:
    branches: [main]

  # æ‰‹å‹•å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      max_repairs:
        description: 'æœ€å¤§ä¿®å¾©å›æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3ï¼‰'
        required: false
        default: '3'
        type: string

jobs:
  claude-review-and-repair:
    name: Claude Review & Auto Repair
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      # ========================================
      # 1. ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      # ========================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œå…¨ãªå±¥æ­´ã‚’å–å¾—ï¼ˆå·®åˆ†æ¯”è¼ƒç”¨ï¼‰

      # ========================================
      # 2. Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # ========================================
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jq
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # ========================================
      # 3. çŠ¶æ…‹ç®¡ç†ã®åˆæœŸåŒ–
      # ========================================
      - name: Initialize repair state
        id: init
        run: |
          MAX_REPAIRS=${{ github.event.inputs.max_repairs || '3' }}
          echo "max_repairs=$MAX_REPAIRS" >> $GITHUB_OUTPUT
          
          if [ ! -f state.json ]; then
            cat > state.json <<EOF
          {
            "repair_count": 0,
            "last_hash": "",
            "last_error": "",
            "last_review_time": "$(date -Iseconds)",
            "total_issues_found": 0,
            "total_issues_fixed": 0
          }
          EOF
          fi
          
          echo "State initialized"
          cat state.json

      # ========================================
      # 4. å·®åˆ†ç¢ºèª
      # ========================================
      - name: Check diff
        id: diff
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # PRã®å ´åˆã¯base branchã¨ã®å·®åˆ†
            git diff origin/${{ github.base_ref }}...HEAD > current.diff
          else
            # pushã®å ´åˆã¯å‰å›ã®ã‚³ãƒŸãƒƒãƒˆã¨ã®å·®åˆ†
            git diff HEAD^ HEAD > current.diff
          fi
          
          # å·®åˆ†ãƒãƒƒã‚·ãƒ¥ã‚’è¨ˆç®—
          DIFF_HASH=$(sha256sum current.diff | cut -d ' ' -f1)
          echo "diff_hash=$DIFF_HASH" >> $GITHUB_OUTPUT
          echo "Diff hash: $DIFF_HASH"
          
          # å·®åˆ†ã‚µã‚¤ã‚ºç¢ºèª
          DIFF_SIZE=$(wc -l < current.diff)
          echo "diff_lines=$DIFF_SIZE" >> $GITHUB_OUTPUT
          echo "Diff size: $DIFF_SIZE lines"

      # ========================================
      # 5. ç°¡æ˜“ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œï¼ˆClaude CLIä¸è¦ç‰ˆï¼‰
      # ========================================
      - name: Run code review
        id: review
        continue-on-error: true
        run: |
          echo "ğŸ” ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œä¸­..."
          
          # Pythonã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
          REVIEW_RESULT="OK"
          
          # Flake8ã§ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
          if [ -d "app" ]; then
            if ! flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics; then
              REVIEW_RESULT="NG"
              echo "âŒ Flake8ã§é‡å¤§ãªã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            fi
          fi
          
          # Banditã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
          if [ -d "app" ]; then
            if ! bandit -r app/ -ll -f json -o bandit-report.json; then
              REVIEW_RESULT="NG"
              echo "âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            fi
          fi
          
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’ä¿å­˜
          cat > review-output.txt <<EOF
          ## ç·åˆåˆ¤å®š
          $REVIEW_RESULT
          
          ## ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¦‚è¦
          - Flake8ãƒã‚§ãƒƒã‚¯: å®Ÿè¡Œå®Œäº†
          - Banditã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³: å®Ÿè¡Œå®Œäº†
          
          ## è©³ç´°
          è©³ç´°ãªãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã¯å„ãƒ„ãƒ¼ãƒ«ã®å‡ºåŠ›ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
          EOF
          
          echo "review_result=$REVIEW_RESULT" >> $GITHUB_OUTPUT
          cat review-output.txt

      # ========================================
      # 6. è‡ªå‹•ä¿®å¾©å®Ÿè¡Œ
      # ========================================
      - name: Auto fix issues
        id: auto_fix
        if: steps.review.outputs.review_result == 'NG'
        run: |
          echo "ğŸ›  è‡ªå‹•ä¿®å¾©ã‚’å®Ÿè¡Œä¸­..."
          
          REPAIR_COUNT=$(jq -r '.repair_count' state.json)
          MAX_REPAIRS=${{ steps.init.outputs.max_repairs }}
          
          if [ "$REPAIR_COUNT" -ge "$MAX_REPAIRS" ]; then
            echo "âŒ ä¿®å¾©å›æ•°ä¸Šé™åˆ°é”: $REPAIR_COUNT / $MAX_REPAIRS"
            echo "fixed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # è‡ªå‹•ä¿®å¾©å¯èƒ½ãªé …ç›®ã®ä¿®æ­£
          # 1. Black ã§ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
          if [ -d "app" ]; then
            black app/ --line-length=127 || true
          fi
          
          # 2. isort ã§importæ•´ç†
          if [ -d "app" ]; then
            isort app/ --profile black || true
          fi
          
          # 3. æœªä½¿ç”¨importã®å‰Šé™¤ï¼ˆautoflakeï¼‰
          if [ -d "app" ]; then
            pip install autoflake
            autoflake --in-place --remove-all-unused-imports --remove-unused-variables -r app/ || true
          fi
          
          # ä¿®å¾©å¾Œã®å·®åˆ†ç¢ºèª
          if [[ -n $(git status --porcelain) ]]; then
            echo "âœ… è‡ªå‹•ä¿®å¾©ã«ã‚ˆã‚Šå¤‰æ›´ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
            git diff --stat
            echo "fixed=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ ä¿®å¾©ã«ã‚ˆã‚‹å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            echo "fixed=false" >> $GITHUB_OUTPUT
          fi
          
          # çŠ¶æ…‹æ›´æ–°
          NEW_COUNT=$((REPAIR_COUNT + 1))
          jq ".repair_count = $NEW_COUNT" state.json > tmp.json && mv tmp.json state.json

      # ========================================
      # 7. å·®åˆ†å¤‰åŒ–ãƒã‚§ãƒƒã‚¯
      # ========================================
      - name: Check diff changes
        id: diff_check
        if: steps.auto_fix.outputs.fixed == 'true'
        run: |
          # æ–°ã—ã„å·®åˆ†ãƒãƒƒã‚·ãƒ¥ã‚’è¨ˆç®—
          git diff > new.diff
          NEW_HASH=$(sha256sum new.diff | cut -d ' ' -f1)
          
          # å‰å›ã®ãƒãƒƒã‚·ãƒ¥ã¨æ¯”è¼ƒ
          LAST_HASH=$(jq -r '.last_hash' state.json)
          
          if [ "$NEW_HASH" = "$LAST_HASH" ] && [ -n "$LAST_HASH" ]; then
            echo "âŒ å·®åˆ†ãŒå¤‰åŒ–ã—ã¦ã„ã¾ã›ã‚“"
            echo "changed=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… å·®åˆ†ãŒå¤‰åŒ–ã—ã¾ã—ãŸ"
            echo "changed=true" >> $GITHUB_OUTPUT
            
            # ãƒãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
            jq --arg hash "$NEW_HASH" '.last_hash = $hash' state.json > tmp.json && mv tmp.json state.json
          fi

      # ========================================
      # 8. ä¿®å¾©çµæœã‚’ã‚³ãƒŸãƒƒãƒˆ
      # ========================================
      - name: Commit auto-repair changes
        if: steps.auto_fix.outputs.fixed == 'true' && steps.diff_check.outputs.changed == 'true'
        run: |
          git config user.name "claude-auto-repair[bot]"
          git config user.email "claude-auto-repair[bot]@users.noreply.github.com"
          
          git add .
          
          REPAIR_COUNT=$(jq -r '.repair_count' state.json)
          git commit -m "ğŸ¤– è‡ªå‹•ä¿®å¾© (è©¦è¡Œ $REPAIR_COUNT/${{ steps.init.outputs.max_repairs }})" \
            -m "è‡ªå‹•çš„ã«ã‚³ãƒ¼ãƒ‰å“è³ªã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ä¿®æ­£ã—ã¾ã—ãŸ" \
            -m "" \
            -m "- Black: ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ" \
            -m "- isort: importæ–‡ã®æ•´ç†" \
            -m "- autoflake: æœªä½¿ç”¨importå‰Šé™¤" \
            -m "" \
            -m "Co-Authored-By: Claude Auto Repair <noreply@anthropic.com>"
          
          git push

      # ========================================
      # 9. å†ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œ
      # ========================================
      - name: Re-run review
        id: re_review
        if: steps.auto_fix.outputs.fixed == 'true'
        continue-on-error: true
        run: |
          echo "ğŸ” å†ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿè¡Œä¸­..."
          
          REVIEW_RESULT="OK"
          
          if [ -d "app" ]; then
            if ! flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics; then
              REVIEW_RESULT="NG"
            fi
          fi
          
          echo "re_review_result=$REVIEW_RESULT" >> $GITHUB_OUTPUT
          echo "å†ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ: $REVIEW_RESULT"

      # ========================================
      # 10. çµæœãƒ¬ãƒãƒ¼ãƒˆï¼ˆPRã‚³ãƒ¡ãƒ³ãƒˆï¼‰
      # ========================================
      - name: Post PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const repairCount = ${{ steps.init.outputs.max_repairs }};
            const currentCount = JSON.parse(require('fs').readFileSync('state.json', 'utf8')).repair_count;
            const reviewResult = '${{ steps.review.outputs.review_result }}';
            const fixed = '${{ steps.auto_fix.outputs.fixed }}' === 'true';
            const reReviewResult = '${{ steps.re_review.outputs.re_review_result }}';
            
            let body = '## ğŸ¤– Claude Auto Repair ãƒ¬ãƒãƒ¼ãƒˆ\n\n';
            body += `### ğŸ“Š ä¿®å¾©çµ±è¨ˆ\n`;
            body += `- ä¿®å¾©è©¦è¡Œå›æ•°: ${currentCount} / ${repairCount}\n`;
            body += `- åˆå›ãƒ¬ãƒ“ãƒ¥ãƒ¼: ${reviewResult}\n`;
            
            if (fixed) {
              body += `- è‡ªå‹•ä¿®å¾©: âœ… å®Ÿè¡Œæ¸ˆã¿\n`;
              body += `- å†ãƒ¬ãƒ“ãƒ¥ãƒ¼: ${reReviewResult}\n\n`;
              
              if (reReviewResult === 'OK') {
                body += '### âœ… è‡ªå‹•ä¿®å¾©æˆåŠŸ\n\n';
                body += 'ã™ã¹ã¦ã®è‡ªå‹•ä¿®å¾©å¯èƒ½ãªå•é¡ŒãŒè§£æ±ºã•ã‚Œã¾ã—ãŸã€‚\n';
              } else {
                body += '### âš ï¸ è¿½åŠ ã®ä¿®å¾©ãŒå¿…è¦\n\n';
                body += 'ã„ãã¤ã‹ã®å•é¡ŒãŒæ®‹ã£ã¦ã„ã¾ã™ã€‚æ¬¡å›ã®pushã§å†åº¦ä¿®å¾©ã‚’è©¦ã¿ã¾ã™ã€‚\n';
              }
            } else {
              body += `- è‡ªå‹•ä¿®å¾©: ${reviewResult === 'OK' ? 'ä¸è¦' : 'âŒ å¤±æ•—ã¾ãŸã¯å¤‰æ›´ãªã—'}\n\n`;
            }
            
            if (currentCount >= repairCount) {
              body += '\n### ğŸš¨ ä¿®å¾©å›æ•°ä¸Šé™åˆ°é”\n\n';
              body += 'è‡ªå‹•ä¿®å¾©ãŒè¦å®šå›æ•°ã«é”ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã®å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      # ========================================
      # 11. çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆï¼ˆæˆåŠŸæ™‚ï¼‰
      # ========================================
      - name: Reset state on success
        if: steps.re_review.outputs.re_review_result == 'OK' || steps.review.outputs.review_result == 'OK'
        run: |
          cat > state.json <<EOF
          {
            "repair_count": 0,
            "last_hash": "",
            "last_error": "",
            "last_review_time": "$(date -Iseconds)",
            "total_issues_found": 0,
            "total_issues_fixed": 0
          }
          EOF
          echo "âœ… çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ"

      # ========================================
      # 12. ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      # ========================================
      - name: Upload review artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: claude-auto-repair-logs
          path: |
            review-output.txt
            state.json
            current.diff
            bandit-report.json
          retention-days: 7
